<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="singlePageTemplate.css" rel="stylesheet" type="text/css">
    <script src="userData.js"></script>
    <script>

        let globalRecall;
		let globalListing_ID;
        /*
          Calls the google API and searches for the speficied item
          @recall the text to be searched for
        */
        function callGoogleAPI(recall) {
          const request = new XMLHttpRequest();
          const newURL = "https://www.googleapis.com/customsearch/v1?key=AIzaSyAhIeqyY1PV8F7W75WM1AmfrTJ-h6wgHqs&cx=53c47e51af67e0e3a&q=" + recall;
          request.open('GET', newURL, true);
          request.onload = function() {
            console.log(request.response);
              const jsonData = JSON.parse(request.response)
              console.log(jsonData.items);
              createListingTable(jsonData.items);
          }
          request.send();
        }

        /*
          Retrieves the recall to be searched for from the database
          @recall the id of the recall to be searched for
        */
        function getRecall(recall) {
          const request = new XMLHttpRequest();
          const query = "select * from recalls where Recall_ID = " + recall + ";";
          const newURL = updateQueryStringParameter(db_url, 'id', query);
          request.open('GET', newURL, true);
          request.onload = function() {
              const jsonData = JSON.parse(request.response)
              callGoogleAPI(jsonData[0][3]);
          }
          request.send();
        }

        /*
          Used the results from the google API to create a table
        */
        function createListingTable(searchResults) {
          const table = document.getElementById('listingsTableBody');
          table.innerHTML = "";
          for (let i = 0; i < searchResults.length; i++) {
              let row = table.insertRow(i);
              let url = row.insertCell(0);
              let description = row.insertCell(1);
              let checkbox = row.insertCell(2);
              let comment = row.insertCell(3);
              const urlLink = document.createElement('a');
              urlLink.href = searchResults[i].link;
              urlLink.innerHTML = searchResults[i].link;
              url.appendChild(urlLink);
              description.innerHTML = searchResults[i].htmlTitle;
              checkbox.innerHTML = "<input type='checkbox' id='" + searchResults[i][0] + "'>";
              comment.innerHTML = "<input type='text'>";
              
              
              const request = new XMLHttpRequest();
              const query = "INSERT INTO listing (Recall_ID, Listing_URL) VALUES (" + globalRecall + ", " + url + ");";
              const newURL = updateQueryStringParameter(db_url, 'id', query);
              request.open('GET', newURL, true);
              request.onload = function() {
                  const jsonData = JSON.parse(request.response)
              }
              request.send();
			  
			  const request = new XMLHttpRequest();
              const query = "INSERT INTO violation (Violation_ID, Violation_Description) VALUES (" +  + ", " + searchResults[1].htmlTitle + ");";
              const newURL = updateQueryStringParameter(db_url, 'id', query);
              request.open('GET', newURL, true);
              request.onload = function() {
                  const jsonData = JSON.parse(request.response)
              }
              request.send();
         
            }
        }
		/*where Recall_ID = " + recall + ";";*/
        /*function createListingTable2() {
          const request1 = new XMLHttpRequest();
            const query1 = "select * from listing";
            const newURL = updateQueryStringParameter(db_url, 'id', query1);
            request1.open('GET', newURL, true);
            request1.onload = function() {
                const listings = JSON.parse(request1.response);
                //console.log(recordCount);   
                console.log(listings);
                const table = document.getElementById('listingsTableBody');
                table.innerHTML = "";
                for (let i = 0; i < listings.length; i++) {
                    let row = table.insertRow(i);
                    let url = row.insertCell(0);
                    let checkbox = row.insertCell(1);
                    let comment = row.insertCell(2);
                    url.innerHTML = listings[i][6];
                    checkbox.innerHTML = "<input type='checkbox' id='" + listings[i][0] + "'>";
                    if (listings[i][5] == "true") {
                        document.getElementById(listings[i][0]).checked = true;
                    }
                    comment.innerHTML = "<input type='text'>";       
              
            }
          }
          request1.send();
        }*/

        function init() {
        //define event handler for the mouse over event of the p element
        //getData();
        const cookie = decodeURIComponent(document.cookie);
        let id = cookie.substring(cookie.indexOf(' id=') + 4, cookie.indexOf('role') - 2);
        console.log(cookie);
        let recall = cookie.substring(cookie.indexOf(' recall=') + 8, cookie.length);
        console.log(recall);
        globalRecall = recall;
        getRecall(recall);

        //createListingTable(recall);
        }
      
    document.addEventListener("DOMContentLoaded", init);
    </script>
</head>
<body>
  <div class="container"> 
    <!-- Navigation -->
    <header> <a href="">
      
      <img src="cpsc.JPG" alt="">
      <h2 class="logo">Recall Wizard
        <br>
        Consumer Product Safety Commission
      </h2>
      <h2 class="logo"></h2>
    </a>
    <nav>
      <ul>
        <li><a href="CPSCHome.html">HOME</a></li>
        <li><a href="CPSCLogin.html">LOGIN</a></li>
        <li><a href="recallSearch.html">RECALL SEARCH</a></li>
        <li><a href="violationsPage.html">VIOLATIONS</a></li>
      </ul>
    </nav>
  </header>
    <div>
        <script async src="https://cse.google.com/cse.js?cx=53c47e51af67e0e3a"></script>
      <div class="gcse-search"></div>
    </div>
    <button onclick="callGoogleAPI()">Search</button>
    <section id="listingsSection">
      <table id="listingsTable">
        <thead>
            <tr>
                <th>
                    URL
                </th>
                <th>
                    Description
                </th>
                <th>
                    Violation
                </th>
                <th>
                  Comment
                </th>
            </tr>
        </thead>
            <tbody id="listingsTableBody">
  
            </tbody>
    </table>
    </section>
    </div>
</body>
</html>